<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- MuClient version 5.07-pre -->
<!-- Plugin "MaledictionAnnounce" generated by Plugin Wizard -->

<muclient>
  <plugin
   name="MaledictionReport"
   author="Kanaye"
   id="2558d613691a941bb5f1398b"
   language="Lua"
   purpose="A plugin to help you notify others of landed maledictions"
   date_written="2024-7-24 17:59:57"
   requires="5.07"
   version="1.21"
  >  
  </plugin>
  
<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Aliases  -->
  <aliases>
  
	<!-- Alias for turning on/off -->
    <alias
    match="^malrep$"
    enabled="y"
    regexp="y"
    send_to="12"
    sequence="100"
    script="debuff_toggle"
    >
    </alias>

    <!-- Define the alias for HELP FILE -->
    <alias
    match="^malrep\shelp$"
    enabled="y"
    omit_from_output="n"
    regexp="y"
    sequence="100"
    script="OnHelp"
    />
	
	<!-- Alias for changing channel -->
    <alias
    match="^malrep\schannel\s(.*?)$"
    name="SetChannel"
    enabled="y"
    omit_from_output="n"
    regexp="y"
    sequence="100"
    script="SetChannel"
    />
	
	<!-- Alias for checking update -->
    <alias
    match="^malrep\supdate\scheck$"
    enabled="y"
    regexp="y"
    sequence="99"
    script="update_check_alias"
    />
    
    <!-- Alias for installing update -->
    <alias
    match="^malrep\supdate\sinstall$"
    enabled="y"
    regexp="y"
    sequence="99"
    script="update_install_alias"
    />
  
  </aliases>
  
  <!--  Script -->
  <script>
   <![CDATA[
   
 ----------------------- Plugin Update Code -----------------------
 -- Code taken from Durel's dinv plugin, originally via Crowley
require("wait")
require("async")
json = require("json")

 plugin_url = "https://raw.githubusercontent.com/st3rv1s/MaledictionReports/refs/heads/main/MaledictionReport.xml"
 SetVariable("DownloadURL", plugin_url)
 plugin_protocol = "HTTPS"
 plugin_prefix = "[MaledictionReport]"
 
 function update_check_alias()
     update_plugin("check")
     ColourNote("white", "", plugin_prefix .. " Checking for updated version...")
 end
 
 function update_install_alias()
     update_plugin("install")
     ColourNote("white", "", plugin_prefix .. " Checking for and installing updated version...")
 end
 
 function reload_plugin()
     local scriptPrefix = GetAlphaOption("script_prefix")
     local retval
 
     -- If the user has not already specified the script prefix for this version of mush, pick a
     -- reasonable default value
     if (scriptPrefix == "") then
         scriptPrefix = "\\\\\\"
         SetAlphaOption("script_prefix", scriptPrefix)
     end
 
     -- Tell mush to reload the plugin in one second.  We can't do it directly here because a
     -- plugin can't unload itself.  Even if it could, how could it tell mush to load it again
     -- if it weren't installed? 
     retval = Execute(scriptPrefix.."DoAfterSpecial(0.1, \"ReloadPlugin('"..GetPluginID().."')\", sendto.script)")
 end
 
 function update_plugin(mode)
     update_mode = mode
 
     wait.make(get_plugin_file)
 end
 
 function get_plugin_file()
     local urlThread = async.request(plugin_url, plugin_protocol)
 
     if not urlThread then
         note_error("Couldn't create async url request.")
         return
     end
 
     local timeout = 10
     local totTime = 0
     while (urlThread:alive() and totTime < timeout) do
         wait.time(0.1)
         totTime = totTime + 0.1
     end
 
     local remoteRet, pluginData, status, headers, fullStatus = urlThread:join()
 
     if not status then
         ColourNote("red", "", plugin_prefix .. " Couldn't download plugin file. No status code.")
         
         return
     end
 
     if (status ~= 200) then
         ColourNote("red", "", plugin_prefix .. " Plugin file request status code: " .. status .. ": " .. fullStatus)
         return
     end
     
     local currentVersion = GetPluginInfo(GetPluginID(), 19) or 0
     local currentVerStr  = tostring(currentVersion)
     local remoteVerStr   = string.match(pluginData, '%s%s+version="([0-9%.]+)"')
     local remoteVersion  = tonumber(remoteVerStr or "") or 0
 
     if remoteVersion == currentVersion then
         ColourNote("white", "", plugin_prefix .. " You are running the most recent version (v" .. currentVerStr .. ")")
     elseif (remoteVersion < currentVersion) then
         ColourNote("white", "", plugin_prefix .. " You have a newer version than is publicly available. (v" .. currentVerStr .. ")")
     elseif (update_mode == "check") then
         ColourNote("white", "", plugin_prefix .. " You are running v" .. currentVerStr .. ", but there's a newer version v" .. remoteVerStr)
     elseif (update_mode == "install") then
         ColourNote("white", "", plugin_prefix .. " Updating plugin from version " .. currentVerStr .. " to version " .. remoteVerStr) 
 
         local pluginFile = GetPluginInfo(GetPluginID(), 6)
         local file = io.open(pluginFile, "wb")
         file:write(pluginData)
         file:close()
         reload_plugin()
     else
         ColourNote("red", "", plugin_prefix .. " Invalid update mode: " .. update_mode)
     end
 end
 ----------------------- End Plugin Update Code -----------------------

require "gmcphelper"

function OnHelp ()
    local version = GetPluginInfo(GetPluginID(), 19) or 0
    local versionStr = tostring(version)

    world.Note(string.format([[
+-----------------[Malediction Report Version: %s ]-------------------+
|                                                                       |
|          Type 'malrep' to toggle between ON and OFF state.            |
|             Type malrep <channel> to change the channel.              |
|               Type malrep help to display this output                 |
|                                                                       |
|  If plugin is OFF but CommLog plugin is present it will post there!   |
|                                                                       |
+-----------------------------------------------------------------------+
    ]], versionStr))
end

local _Debuff_Master = "OFF"
local _Channel = "say"
local _CurrentKoboldTarget = nil
local _CurrentKoboldSpell = nil
local _ExternalPluginID = "b555825a4a5700c35fa80780"
local _CommLog = "false"

function _checkExternalPlugin()
    local _plugin_info = GetPluginInfo(_ExternalPluginID, 1)
    if _plugin_info then
        _CommLog = "true"
    else
        _CommLog = "false"
    end
end

_checkExternalPlugin()

function debuff_toggle()
    if _Debuff_Master == "ON" then
        _Debuff_Master = "OFF"
        ColourNote("darkred", "dimgrey", "Malediction reports are OFF.")
    else
        _Debuff_Master = "ON"
        ColourNote("limegreen", "dimgrey", "Malediction reports are ON.")
    end
end

function SetChannel(name, line, wildcards)
    _Channel = wildcards[1]
    SetVariable("Save_Channel", _Channel)
    cnote("@WMALREP now broadcasts to @C" .. _Channel .. "@w")
end

function Announce(name, line, wildcards)
    local _target = wildcards[1] or "unknown"
    local _spell = name:upper()

    -- Message for normal channel includes channel prefix
    if _Debuff_Master == "ON" then
        local _message_channel = string.format("%s @W%s'D! @C(@D%s@C)@w", _Channel, _spell, _target)
        SendNoEcho(_message_channel)
    end

    -- Message for external plugin does NOT include channel
    if _Debuff_Master == "OFF" and _CommLog == "true" then
        local _message_comm = string.format("@W%s'D! @C(@D%s@C)@w", _spell, _target)
        CallPlugin(_ExternalPluginID, "storeFromOutside", _message_comm)
    end
end

function KoboldFirstLine(name, line, wildcards)
    _CurrentKoboldTarget = wildcards[1]
    if string.find(line, "huge rotting Kobold", 1, true) then
        _CurrentKoboldSpell = "KSPRAY"
    else
        _CurrentKoboldSpell = "KOBOLD"
    end
end

function KoboldSecondLine(name, line, wildcards)
    if _CurrentKoboldTarget and _CurrentKoboldSpell then
        -- Message for normal channel includes channel
        if _Debuff_Master == "ON" then
            local _message_channel = string.format("%s @W%s'D! @C(@D%s@C)@w", _Channel, _CurrentKoboldSpell:upper(), _CurrentKoboldTarget)
            SendNoEcho(_message_channel)
        end

        -- Message for external plugin does NOT include channel
        if _Debuff_Master == "OFF" and _CommLog == "true" then
            local _message_comm = string.format("@W%s'D! @C(@D%s@C)@w", _CurrentKoboldSpell:upper(), _CurrentKoboldTarget)
            CallPlugin(_ExternalPluginID, "storeFromOutside", _message_comm)
        end
    end

    _CurrentKoboldTarget = nil
    _CurrentKoboldSpell = nil
end

function OnPluginInstall()
	OnHelp()
	_Channel = GetVariable("Save_Channel") or "say"
end

function OnPluginSaveState()
	SetVariable("Save_Channel", _Channel)
end

   ]]>
  </script>

<!-- Include standard constants -->
<include name="constants.lua"/>

   <!-- Triggers -->
  <triggers>
  
    <!-- Trigger for WEAKEN -->
    <trigger
    name="Weaken"
    match="^(.*?) looks tired and weak\.$"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />

	<!-- Trigger for SOFTEN -->
    <trigger
    name="Soften"
    match="^(.*?)\'s armor softens\.$"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"	
    />
	
	<!-- Trigger for RUNE of IX -->
    <trigger
    name="Rune"
    match="^You mark (.+) with a Rune of IX\!"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
	<!-- Trigger for EGO -->
    <trigger
    name="Ego"
    match="^You ridicule (.*?) about (.*?) childhood\.$"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
	<!-- Trigger for RAW FLESH -->
    <trigger
    name="RawFlesh"
    match="^(.*?)'s flesh is ripped from (.*?)'s body\.$"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
	<!-- Trigger for DISEASE -->
    <trigger
    name="Disease"
    match="^(.+) looks unwell\."
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
	<!-- Trigger for CURSE -->
    <trigger
    name="Curse"
    match="^(.*?) looks (.*?) uncomfortable\.$"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
	<!-- Trigger for MARBU -->
    <trigger
    name="Marbu"
    match="^(.+) falls to (.+?) knees blinded\."
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
	<!-- Trigger for HYDRA -->
    <trigger
    name="Hydra"
    match="^(.+) appears to falter\. Your victim is in serious trouble\!$"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
	<!-- Trigger for GREEN DEATH -->
    <trigger
    name="GreenDeath"
    match="^(.+) appears much weaker and extremely vulnerable\."
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />

	<!-- Trigger for RAVEN -->
    <trigger
    name="Raven"
    match="^Your acidic venom burns away (.+)\'s armor\.$"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
	<!-- Trigger for KOBOLDS -->
    <trigger
    name="KsprayFirstLine"
    match="^You spray (.+) with a huge rotting Kobold gland\.$"
    enabled="y"
    regexp="y"
    ignore_case="y"
    script="KoboldFirstLine"
	/>
    
    <trigger
    name="KoboldFirstLine"
    match="^You spray (.+) with a rotting kobold gland\.$"
    enabled="y"
    regexp="y"
    ignore_case="y"
    script="KoboldFirstLine"
	/>
    
    <trigger
    name="KoboldSecondLine"
    match="^(.+) turns pale and appears weakened\.$"
    enabled="y"
    regexp="y"
    ignore_case="y"
    script="KoboldSecondLine"
	/>

   <!-- Trigger for THIEF -->
	
	<!-- Trigger for NECRO -->
    <trigger
    name="Necro"
    match="^You reach out and touch (.+), injecting (.+) with deadly necrotic poison\.$"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
    <trigger
    name="Balor"
    match="^You sense that your poison has greatly reduced (.+?)'?s? health\.$"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
	<trigger
    name="Assassinate"
    match="^You assassinate (.+?) with cold efficiency\.$"
    enabled="y"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
	<!-- Trigger for SPECIAL -->
	
    <!-- Trigger for SANCTUARY -->
    <trigger
    name="Sanc"
    match="^The white aura around (.+)\'s body vanishes\.$"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
    <!-- Trigger for REVERSE ALIGN -->
    <trigger
    name="RevEvil"
    match="^You banish (.+?) to the forces of (shadow|light)\.$"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
	<!-- Trigger for FLIES -->
    <trigger
    name="Flies"
    match="^You unleash a swarm of flies upon (.+?)\!$"
    enabled="y"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
	script="Announce"
    />
	
  </triggers>

</muclient>


