<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- MuClient version 5.07-pre -->
<!-- Plugin "MaledictionAnnounce" generated by Plugin Wizard -->

<muclient>
  <plugin
   name="MaledictionReport"
   author="Kanaye"
   id="2558d613691a941bb5f1398b"
   language="Lua"
   purpose="A plugin to help you notify others of landed maledictions"
   date_written="2024-7-24 17:59:57"
   requires="5.07"
   version="1.1"
  >
  
<description trim="y">
<![CDATA[

+-------------------------[Malediction Report!]-------------------------+
|                                                                       |
|          Type 'malrep' to toggle between ON and OFF state.            |
|                                                                       |
+-----------------------------------------------------------------------+

]]>
</description> 
  
  </plugin>
  
<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Aliases  -->
  <aliases>
  
    <alias
    match="^malrep$"
    enabled="y"
    regexp="y"
    send_to="12"
    sequence="100"
    script="debuff_toggle"
    >
    </alias>
	
	<!-- Alias for checking update -->
    <alias
      match="^malrep\supdate\scheck$"
      enabled="y"
      regexp="y"
      sequence="99"
      script="update_check_alias"
    />
    
    <!-- Alias for installing update -->
    <alias
      match="^malrep\supdate\sinstall$"
      enabled="y"
      regexp="y"
      sequence="99"
      script="update_install_alias"
    />
  
  </aliases>
  
  <!--  Script -->
  <script>
   <![CDATA[
   
 ----------------------- Plugin Update Code -----------------------
 -- Code taken from Durel's dinv plugin, originally via Crowley
require("wait")
require("async")
json = require("json")

 plugin_url = "https://raw.githubusercontent.com/st3rv1s/SlopeTrain/refs/heads/main/MaledictionReport.xml"
 SetVariable("DownloadURL", plugin_url)
 plugin_protocol = "HTTPS"
 plugin_prefix = "[MaledictionReport]"
 
 function update_check_alias()
     update_plugin("check")
     ColourNote("white", "", plugin_prefix .. " Checking for updated version...")
 end
 
 function update_install_alias()
     update_plugin("install")
     ColourNote("white", "", plugin_prefix .. " Checking for and installing updated version...")
 end
 
 function reload_plugin()
     local scriptPrefix = GetAlphaOption("script_prefix")
     local retval
 
     -- If the user has not already specified the script prefix for this version of mush, pick a
     -- reasonable default value
     if (scriptPrefix == "") then
         scriptPrefix = "\\\\\\"
         SetAlphaOption("script_prefix", scriptPrefix)
     end
 
     -- Tell mush to reload the plugin in one second.  We can't do it directly here because a
     -- plugin can't unload itself.  Even if it could, how could it tell mush to load it again
     -- if it weren't installed? 
     retval = Execute(scriptPrefix.."DoAfterSpecial(0.1, \"ReloadPlugin('"..GetPluginID().."')\", sendto.script)")
 end
 
 function update_plugin(mode)
     update_mode = mode
 
     wait.make(get_plugin_file)
 end
 
 function get_plugin_file()
     local urlThread = async.request(plugin_url, plugin_protocol)
 
     if not urlThread then
         note_error("Couldn't create async url request.")
         return
     end
 
     local timeout = 10
     local totTime = 0
     while (urlThread:alive() and totTime < timeout) do
         wait.time(0.1)
         totTime = totTime + 0.1
     end
 
     local remoteRet, pluginData, status, headers, fullStatus = urlThread:join()
 
     if not status then
         ColourNote("red", "", plugin_prefix .. " Couldn't download plugin file. No status code.")
         
         return
     end
 
     if (status ~= 200) then
         ColourNote("red", "", plugin_prefix .. " Plugin file request status code: " .. status .. ": " .. fullStatus)
         return
     end
     
     local currentVersion = GetPluginInfo(GetPluginID(), 19) or 0
     local currentVerStr  = string.format("%1.3f", currentVersion)
     local remoteVerStr   = string.match(pluginData, '%s%s+version="([0-9%.]+)"')
     local remoteVersion  = tonumber(remoteVerStr or "") or 0
 
     if remoteVersion == currentVersion then
         ColourNote("white", "", plugin_prefix .. " You are running the most recent version (v" .. currentVerStr .. ")")
     elseif (remoteVersion < currentVersion) then
         ColourNote("white", "", plugin_prefix .. " You have a newer version than is publicly available. (v" .. currentVerStr .. ")")
     elseif (update_mode == "check") then
         ColourNote("white", "", plugin_prefix .. " You are running v" .. currentVerStr .. ", but there's a newer version v" .. remoteVerStr)
     elseif (update_mode == "install") then
         ColourNote("white", "", plugin_prefix .. " Updating plugin from version " .. currentVerStr .. " to version " .. remoteVerStr) 
 
         local pluginFile = GetPluginInfo(GetPluginID(), 6)
         local file = io.open(pluginFile, "wb")
         file:write(pluginData)
         file:close()
         reload_plugin()
     else
         ColourNote("red", "", plugin_prefix .. " Invalid update mode: " .. update_mode)
     end
 end
 ----------------------- End Plugin Update Code -----------------------

require "gmcphelper"

function OnHelp ()
  world.Note (world.GetPluginInfo (world.GetPluginID (), 3))
end

local debuff_master = "ON"

function debuff_toggle()
 	if debuff_master == "ON"
 		then
 			debuff_master = "OFF"
 			EnableGroup("debuffs", false)
			ColourNote ("darkred", "dimgrey", "Malediction reports are DISABLED!")
	elseif debuff_master == "OFF"
		then
			debuff_master = "ON"
			EnableGroup("debuffs", true)
			ColourNote ("limegreen", "dimgrey", "Malediction reports are ENABLED!")
	end
end

function OnPluginInstall()
	OnHelp()
end

   ]]>
  </script>

<!-- Include standard constants -->
<include name="constants.lua"/>

   <!-- Triggers -->
  <triggers>
  
    <!-- Trigger for FLIES -->
    <trigger
      name="Flies"
      match="^You unleash a swarm of flies upon (.+?)!$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("gt @WFLIED! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
    <!-- Trigger for SANCTUARY -->
    <trigger
      name="Sanc"
      match="^The white aura around (.+)\'s body vanishes\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("say @WSANC OFF! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
    <!-- Trigger for REVERSE ALIGN (EVIL) -->
    <trigger
      name="RevEvil"
      match="^You banish (.+?) to the forces of shadow\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("gt @WREV'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
    <!-- Trigger for REVERSE ALIGN (GOOD) -->
    <trigger
      name="RevGood"
      match="^You banish (.+?) to the forces of light\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("gt @WREV'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
    <!-- Trigger for WEAKEN -->
    <trigger
      name="Weaken"
      match="^(.*?) looks tired and weak\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("say @WWEAKEN'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
	<!-- Trigger for SOFTEN -->
    <trigger
      name="Soften"
      match="^(.*?)\'s armor softens\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("say @WSOFTEN'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
	<!-- Trigger for RUNE of IX -->
    <trigger
      name="Rune"
      match="^You mark (.+) with a Rune of IX!"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("say @WRUNE'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
	<!-- Trigger for RAVEN SPRAY -->
    <trigger
      name="Raven"
      match="^Your acidic venom burns away (.+)\'s armor\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("say @WRAVEN'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
	<!-- Trigger for MARBU -->
    <trigger
      name="Marbu"
      match="^(.+) falls to (.*?) knees blinded."
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("say @WMARBU'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
  <!-- Trigger for the first line of Kspray -->
  <trigger
    name="KsprayFirstLine"
    match="^You spray (.+) with a huge rotting Kobold gland\.$"
    enabled="y"
	group="debuffs"
    regexp="y"
    send_to="12"
    ignore_case="y"
    sequence="100"
    >
    <send>
      -- Store the matched part and set the context for Kspray
      world.SetVariable("KsprayTarget", "%1")
      world.SetVariable("CurrentAction", "Kspray")
    </send>
    </trigger>
    
    <!-- Trigger for the first line of Kobold -->
    <trigger
      name="KoboldFirstLine"
      match="^You spray (.+) with a rotting kobold gland\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="110"
      >
      <send>
        -- Store the matched part and set the context for Kobold
        world.SetVariable("KoboldTarget", "%1")
        world.SetVariable("CurrentAction", "Kobold")
      </send>
    </trigger>
    
    <!-- Combined trigger for the second line -->
    <trigger
      name="SecondLineCombined"
      match="^(.+) turns pale and appears weakened\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="120"
      >
      <send>
        -- Check the current action context and act accordingly
        local action = world.GetVariable("CurrentAction")
        local target = nil
        
        if action == "Kspray" then
          target = world.GetVariable("KsprayTarget")
          if target then
            SendNoEcho(string.format("say @WKSPRAY'D! @C(@D%s@C)@Y", target))
            -- Clear the variable after use
            world.SetVariable("KsprayTarget", "")
          end
        elseif action == "Kobold" then
          target = world.GetVariable("KoboldTarget")
          if target then
            SendNoEcho(string.format("say @WKOBOL'D! @C(@D%s@C)@Y", target))
            -- Clear the variable after use
            world.SetVariable("KoboldTarget", "")
          end
        end
        
        -- Clear the action context after processing
        world.SetVariable("CurrentAction", "")
      </send>
    </trigger>
	
	<!-- Trigger for HYDRA -->
    <trigger
      name="Hydra"
      match="^(.+) appears to falter. Your victim is in serious trouble\!$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("say @WHYDRA'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
	<!-- Trigger for GREEN DEATH -->
    <trigger
      name="GreenDeath"
      match="^(.+) appears much weaker and extremely vulnerable."
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("say @WGREEN DEATH'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
	<!-- Trigger for GREEN DEATH -->
    <trigger
      name="Ego"
      match="^You ridicule (.*?) about (.*?) childhood\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("say @WEGO'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
	<!-- Trigger for DISEASE -->
    <trigger
      name="Disease"
      match="^(.+) looks unwell."
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("say @WDISEASE'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
	<!-- Trigger for CURSE -->
    <trigger
      name="Curse"
      match="^(.*?) looks (.*?) uncomfortable\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("say @WCURSE'D! @C(@D%1@C)@Y")
      </send>
    </trigger>

   <!-- Trigger for THIEF -->
	
	<!-- Trigger for NECRO -->
    <trigger
      name="Necro"
      match="^You reach out and touch (.+), injecting (.+) with deadly necrotic poison\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100" 
    >
      <send>
	  -- Broadcast the malediction
      SendNoEcho("say @WNECRO'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
    <trigger
      name="Balor"
      match="^.*You sense that your poison has greatly reduced (.*?)'s health\.$|^You sense that your poison has greatly reduced (.*?) health\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100"
    >
      <send>
      -- Broadcast the malediction
      SendNoEcho("say @WBALOR'D! @C(@D%1@C)@Y")
      </send>
    </trigger>
	
	<trigger
      name="Assassinate"
      match="^You assassinate (/+?) with cold efficiency\.$"
      enabled="y"
	  group="debuffs"
      regexp="y"
      send_to="12"
      ignore_case="y"
      sequence="100"
    >
      <send>
      -- Broadcast the malediction
      SendNoEcho("gt @WASS'D @C(@D%1@C)@Y")
      </send>
    </trigger>
	
  </triggers>

</muclient>
